<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:o="http://omnifaces.org/ui"
	xmlns:of="http://omnifaces.org/functions"
	template="/uii/template/template.html"
	xmlns:x="http://myfaces.apache.org/tomahawk"
	xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites">

	<ui:param name="myPageTitle"
		value="#{msgs.plugin}: #{msgs[('plugin_').concat(AktuelleSchritteForm.myPlugin.title)]}" />

	<ui:define name="breadcrumb">
        <intranda:breadcrumb label="#{msgs.startseite}" action="index" navId="a0" />
        
        <c:if test="#{LoginForm.hasRole('Workflow_Processes') and NavigationForm.uiStatus.pluginSimulation == true}">
			<intranda:breadcrumb id="processAll" label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.aktuelleProzesse:msgs.prozessvorlagen}" action="process_all" navId="a1" />
			<intranda:breadcrumb id="processEdit" label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.prozessDetails:msgs.process_templateDetails}" action="process_edit" />
		</c:if>
        
        <c:if test="#{NavigationForm.uiStatus.pluginSimulation != true}">
		    <intranda:breadcrumb label="#{msgs.aktuelleSchritte}" action="#{AktuelleSchritteForm.paginator.returnToPreviousPage}" />
    	   		<intranda:breadcrumb label="#{AktuelleSchritteForm.mySchritt.prozess.titel}" action="#{AktuelleSchritteForm.myPlugin.cancel}" />
		</c:if>
        
        <intranda:breadcrumb label="#{myPageTitle}" noSeparator="#{true}" />
    </ui:define>

	<ui:define name="info">
	</ui:define>

	<ui:define name="content">

		<style>
.big-image-caption {
	text-align: center;
}

.div-image img {
	float: right;
	border: solid 1px;
	border-color: lightgrey;
}

.img-active {
	background-color: #368ee0;
	color: white;
}

.image-navigation {
	margin-bottom: 5px;
}

#image-control-wrapper {
	margin-left: 6px;
}

#mainImage {
	widht: 100%;
}

.pagenum {
	opacity: 0.2;
	background: #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
}

.title {
	opacity: 0.2;
	background-color: #{AktuelleSchritteForm.myPlugin.colors['title']};
}

.author {
	opacity: 0.2;
	background-color: #{AktuelleSchritteForm.myPlugin.colors['author']};
}

.institution {
	opacity: 0.2;
	background-color: #{AktuelleSchritteForm.myPlugin.colors['institution']};
}

.entry {
	opacity: 0.2;
	background-color: #{AktuelleSchritteForm.myPlugin.colors['entry']};
}

.pagenum-border {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
}

.title-border {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['title']};
}

.author-border {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['author']};
}

.institution-border {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['institution']};
}

.entry-border {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['entry']};
}



.active-entry .pagenum-border-focus {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
}

.active-entry .title-border-focus {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['title']};
}

.active-entry .author-border-focus {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['author']};
}

.active-entry .institution-border-focus {
	border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['institution']};
}

.active-entry .control-label label {
	font-weight: bold;
}

.toc-entry.active-entry .form-group .col-sm-9 {
	background-color: #f6f6f6;
}

.toc-entry.active-entry .form-group {
	background-color: #e6e6e6;
}

.scroll-y {
	overflow-y: auto;
	overflow-x: hidden;
	direction: rtl;
}

.scroll-y div {
 	direction: ltr; 
}

.max-height {
	max-height: 1106px;
	height: 1106px;
}
</style>

		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon-viewerinputhook.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/rx.lite.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/q.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.controls.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.zoomSlider.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.overlays.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.tileSourceResolver.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.measures.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/rectDrawing.js"></script>

		
			<div class="box box-color lightgrey box-bordered">
						<h:form>
				<div class="box-title">
					<h3>
						<i class="fa fa-puzzle-piece" />
						<h:outputText id="id9" value="#{msgs.details}" />
					</h3>
					<div class="actions">
							<h:commandLink id="id10" action="#{NavigationForm.Reload}"
								styleClass="btn btn-mini">
								<i class="fa fa-refresh font-white" />
							</h:commandLink>
					</div>
				</div>
						</h:form>
				
				
				<div class="box-content nopadding">
					<div class="row">
						<h:form id="qaform" styleClass="form-horizontal form-bordered">
						<div class="col-sm-7">
							<h:panelGroup id="entrylist" layout="block" class=" max-height scroll-y">
							
								<x:dataList value="#{AktuelleSchritteForm.myPlugin.tih.image.entryList}" var="entry" rowIndexVar="idx">
									<div class="row">
										<div class="col-sm-11 toc-entry" id="tocEntry#{idx}">
											<intranda:formInputText style="border-right:1px solid #ccc"
												label="#{msgs.plugin_intranda_step_olr_toc_title}"
												field="#{entry.title}" classLeft="col-sm-2" classRight="col-sm-10"
												help="#{msgs.plugin_intranda_step_olr_toc_title}"
												name="title" fieldStyle="form-control title-border-focus"
												displayAsRequired="false" required="false" forceId="false" 
												onfocus="$('.toc-entry').removeClass('active-entry'); $(this).parent().parent().parent().addClass('active-entry'); drawRectNumber(viewImage, entries, #{AktuelleSchritteForm.myPlugin.tih.image.scale}, #{idx});"/>
											<intranda:formInputText style="border-right:1px solid #ccc"
												label="#{msgs.plugin_intranda_step_olr_toc_authors}"
												field="#{entry.authors}" classLeft="col-sm-2" classRight="col-sm-10"
												help="#{msgs.plugin_intranda_step_olr_toc_authors}"
												name="authors" fieldStyle="form-control author-border-focus"
												displayAsRequired="false" required="false" forceId="false" 
												onfocus="$('.toc-entry').removeClass('active-entry'); $(this).parent().parent().parent().addClass('active-entry'); drawRectNumber(viewImage, entries, #{AktuelleSchritteForm.myPlugin.tih.image.scale}, #{idx});"/>
											<intranda:formInputText style="border-right:1px solid #ccc"
												label="#{msgs.plugin_intranda_step_olr_toc_institutions}"
												field="#{entry.institutions}" classLeft="col-sm-2" classRight="col-sm-10"
												help="#{msgs.plugin_intranda_step_olr_toc_institutions}"
												name="institutions" fieldStyle="form-control institution-border-focus"
												displayAsRequired="false" required="false" forceId="false" 
												onfocus="$('.toc-entry').removeClass('active-entry'); $(this).parent().parent().parent().addClass('active-entry'); drawRectNumber(viewImage, entries, #{AktuelleSchritteForm.myPlugin.tih.image.scale}, #{idx});"/>
											<intranda:formInputText style="border-right:1px solid #ccc; border-bottom:2px solid #ccc"
												label="#{msgs.plugin_intranda_step_olr_toc_page}"
												field="#{entry.pageLabel}" classLeft="col-sm-2" classRight="col-sm-10"
												help="#{msgs.plugin_intranda_step_olr_toc_page}"
												name="pageLabel" fieldStyle="form-control pagenum-border-focus"
												displayAsRequired="false" required="false" forceId="false" 
												onfocus="$('.toc-entry').removeClass('active-entry'); $(this).parent().parent().parent().addClass('active-entry'); drawRectNumber(viewImage, entries, #{AktuelleSchritteForm.myPlugin.tih.image.scale}, #{idx});"/>
										</div>
										<div class="col-sm-1 nopadding">
											<h:commandLink
												title="#{msgs.plugin_intranda_step_olr_toc_deleteEntry}"
												action="#{AktuelleSchritteForm.myPlugin.tih.image.removeEntry}"
												styleClass="btn font-size-s margin-top-regular" style="margin-right:30px;">
												<i class="fa fa-trash-o"></i>
												<f:setPropertyActionListener value="#{entry}"
													target="#{AktuelleSchritteForm.myPlugin.tih.image.currentEntry}"/>
												<f:ajax render=":qaform:entrylist :qaform:bigimage" />
											</h:commandLink>
										</div>
	
									</div>
								</x:dataList>
							
							</h:panelGroup>
						</div>
						<div class="col-sm-5" style="padding:10px;right:30px;">
							
							<h:panelGroup id="bigimage">
								
									<div class="row">
										<f:subview id="first_image">
											<ui:include
												src="OlrTocCorrectionPlugin_include_imagenavigation.xhtml" />
										</f:subview>
									</div>
								
								<!-- big image -->
								<div class="row margin-top-most margin-bottom-most">
									<h:panelGroup styleClass="div-image" layout="block">
										<!--                                     <h:graphicImage class="margin-bottom-regular" value="#{AktuelleSchritteForm.myPlugin.bild}" rendered="#{AktuelleSchritteForm.myPlugin.image != null}" width="100%" /> -->
										<div id="mainImage" class="margin-bottom-regular"
											rendered="#{AktuelleSchritteForm.myPlugin.tih.image != null}" />
										<div class="big-image-caption margin-top-regular font-light">
											<h:outputText
												value="#{AktuelleSchritteForm.myPlugin.tih.image.imageName}" />
										</div>
										<script type="text/javascript">
                                    $('#mainImage').height($('#mainImage').width() * #{AktuelleSchritteForm.myPlugin.tih.imageHeight}/#{AktuelleSchritteForm.myPlugin.tih.imageWidth});
                                    
                                    var entryGroup = {
	                                        name : "entry",
	                                        styleClass : "entry",
	                                        interactive: false
	                                    }; 
                                    var authorGroup = {
	                                        name : "author",
	                                        styleClass : "author",
	                                        interactive: false
	                                    }; 
                                    var pagenumGroup = {
	                                        name : "pagenum",
	                                        styleClass : "pagenum",
	                                        interactive: false
	                                    }; 
                                    var institutionGroup = {
	                                        name : "institution",
	                                        styleClass : "institution",
	                                        interactive: false
	                                    }; 
                                    var titleGroup = {
	                                        name : "title",
	                                        styleClass : "title",
	                                        interactive: false
	                                    }; 
                                    
                                    var entryBorderGroup = {
	                                        name : "entry-border",
	                                        styleClass: "entry-border",
	                                        interactive: false
	                                    }; 
                                    var authorBorderGroup = {
	                                        name : "author-border",
	                                        styleClass: "author-border",
	                                        interactive: false
	                                    }; 
                                    var pagenumBorderGroup = {
	                                        name : "pagenum-border",
	                                        styleClass: "pagenum-border",
	                                        interactive: false
	                                    }; 
                                    var institutionBorderGroup = {
	                                        name : "institution-border",
	                                        styleClass: "institution-border",
	                                        interactive: false
	                                    }; 
                                    var titleBorderGroup = {
	                                        name : "title-border",
	                                        styleClass: "title-border",
	                                        interactive: false
	                                    }; 
                                    var imageViewConfig = {
                            			    global: {
                            			        zoomSpeed: 0,
                            			        divId : 'mainImage',
                            			        zoomSlider : 'zoomSlider',
                            			        maxZoomLevel: 10,
                            			        overlayGroups: [entryGroup, authorGroup, pagenumGroup, institutionGroup, titleGroup,
                            			            entryBorderGroup, authorBorderGroup, pagenumBorderGroup, institutionBorderGroup, titleBorderGroup] 
                            			    },
                            			    image: {
                                                mimeType: "image/jpg",
                                                tileSource : '#{AktuelleSchritteForm.myPlugin.tih.image.imageUrl}',
                                            } 
                            			};
                                    viewImage.close();
                                    viewImage.init(imageViewConfig).then(function() {
	                                    entries = JSON.parse('#{AktuelleSchritteForm.myPlugin.tih.image.entriesAsJSON}');
	                                    scaleFactor = #{AktuelleSchritteForm.myPlugin.tih.image.scale};
	                                    if(#{NavigationForm.uiStatus.olr_showAllEntries eq 'on'?'true':'false'}) {
	                                        drawAllRects(viewImage, entries, scaleFactor);
	                                    } else {
	                                    	$('#tocEntry'+0).find('input').first().focus();
	                                    }
	                                    $( '#mainImage' ).click( function( event ) {
	                                        if(event.target.nodeName !== "CANVAS") {
	                                            return;
	                                        }
	                                        var pixel = new OpenSeadragon.Point( event.offsetX, event.offsetY );
	                                        var pos = viewImage.viewer.viewport.viewerElementToImageCoordinates( pixel );
	                                        findAndMarkRect(entries, pos, scaleFactor);
	                                    } );
                                    }).catch(function(err) {
                                        console.log(err);
                                    });
                                    </script>
									</h:panelGroup>
								</div>
								<!-- // big image -->

								
									<div class="row">
										<f:subview id="second_image">
											<ui:include
												src="OlrTocCorrectionPlugin_include_imagenavigation.xhtml" />
										</f:subview>
									</div>
								
							</h:panelGroup>
						</div>

						<h:panelGroup layout="block"
							rendered="#{AktuelleSchritteForm.myPlugin.tih.sizeOfImageList == 0}"
							styleClass="col-sm-12">
							<h:outputText value="#{msgs.noImagesFound}" />
						</h:panelGroup>
						</h:form>
					</div>

					<div class="form-actions">
						<h:form>
						<!-- Remove all entries of this page -->
						<h:commandLink
							title="#{msgs.plugin_intranda_step_olr_toc_deleteAllEntriesOfThisPage}"
							action="#{AktuelleSchritteForm.myPlugin.tih.image.removeAllEntriesOfThisPage}"
							styleClass="btn btn-red font-size-s margin-right-10"
							onclick="if (!confirm('#{msgs.wirklichAusfuehren}')) return false" >
							<i class="fa fa-trash-o margin-right-5"></i>
							<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_deleteAllEntriesOfThisPage}"/>
						</h:commandLink>

						<!-- Create new entry -->
						<h:commandLink
							title="#{msgs.plugin_intranda_step_olr_toc_createEntry}"
							styleClass="btn btn-blue font-size-s"
							action="#{AktuelleSchritteForm.myPlugin.tih.image.createEntry}">
							<i class="fa fa-plus margin-right-5"></i>
							<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_createEntry}"/>
							<f:ajax render=":qaform:entrylist"/>
						</h:commandLink>

						<!-- Save -->
						<h:commandLink styleClass="btn btn-success pull-right font-size-s"
							id="save" action="#{AktuelleSchritteForm.myPlugin.finish}">
							<i class="fa fa-save margin-right-5"></i>
							<h:outputText
								value="#{msgs.plugin_intranda_step_olr_toc_saveAndLeave}" />
						</h:commandLink>

						<!-- Pica preview -->
						<h:commandLink styleClass="btn font-size-s pull-right margin-right-10" id="picaPreview"
							action="#{AktuelleSchritteForm.myPlugin.showPicaPreview}">
							<h:outputText
								value="#{msgs.plugin_intranda_step_olr_toc_showPicaPreview}" />
						</h:commandLink>
						
						<!-- Cancel -->
						<h:commandLink styleClass="btn font-size-s pull-right margin-right-10" id="cancel"
							action="#{AktuelleSchritteForm.myPlugin.cancel}">
							<h:outputText
								value="#{msgs.plugin_intranda_step_olr_toc_pluginLeave}" />
						</h:commandLink>
						</h:form>
					</div>

				</div>
			</div>
			
			<h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.picaPreview != null}" style="margin-top:20px;display:block;">
				
				<h:outputText value="#{AktuelleSchritteForm.myPlugin.picaPreview}" escape="false"/>

				<!-- Close PICA preview -->
				<h:form>
					<h:commandLink styleClass="btn font-size-s margin-top-10" id="picaPreview"
						action="#{AktuelleSchritteForm.myPlugin.closePicaPreview}">
						<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_closePicaPreview}" />
					</h:commandLink>
				</h:form>
			</h:panelGroup>

		<script type="text/javascript">

	window.onload = function() {
    	loadImages();
    }
	
  


jsf.ajax.addOnEvent(function(data) {
    var ajaxstatus = data.status; // Can be "begin", "complete" and "success"
      
      switch (ajaxstatus) {
          case "success": // This is called when ajax response is successfully processed.
              loadImages();
            
              break;
      }
	
});

function copyValue(element, e) {
    console.log(element.id);
    if (element.id =='qaform:first:txtMoveTo2') {
        document.getElementById('qaform:second:txtMoveTo2').value = element.value;
    } else if (element.id =='qaform:second:txtMoveTo2'){
        document.getElementById('qaform:first:txtMoveTo2').value = element.value;
    } else if (element.id =='qaform:first_image:txtImageMoveTo2') {
        document.getElementById('qaform:second_image:txtImageMoveTo2').value = element.value;
    } else {
        document.getElementById('qaform:first_image:txtImageMoveTo2').value = element.value;
    }
    
    var keycode;
	if (window.event)
		keycode = window.event.keyCode;
	else if (e)
		keycode = e.which;
	else
		return true;
	
	if (keycode == 13) {
		document.getElementById(element.id).nextSibling.click();
		return false;
	} else
		return true;
    
}

</script>
	</ui:define>

</ui:composition>