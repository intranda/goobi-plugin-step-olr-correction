<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:o="http://omnifaces.org/ui"
	xmlns:of="http://omnifaces.org/functions"
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	template="/uii/template/template.html"
	xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
    xmlns:section="http://goobi.io/section"
    xmlns:button="http://goobi.io/button">

	<ui:param name="myPageTitle"
		value="#{msgs.plugin}: #{msgs[('plugin_').concat(AktuelleSchritteForm.myPlugin.title)]}" />

	<ui:define name="breadcrumb">
        <intranda:breadcrumb label="#{msgs.startseite}" action="index" navId="a0" />

        <c:if test="#{LoginForm.hasRole('Workflow_Processes') and NavigationForm.uiStatus.pluginSimulation == true}">
			<intranda:breadcrumb id="processAll" label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.aktuelleProzesse:msgs.prozessvorlagen}" action="process_all" navId="a1" />
			<intranda:breadcrumb id="processEdit" label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.prozessDetails:msgs.process_templateDetails}" action="process_edit" />
		</c:if>

        <c:if test="#{NavigationForm.uiStatus.pluginSimulation != true}">
		    <intranda:breadcrumb label="#{msgs.aktuelleSchritte}" action="#{AktuelleSchritteForm.paginator.returnToPreviousPage}" />
    	   		<intranda:breadcrumb label="#{AktuelleSchritteForm.mySchritt.prozess.titel}" action="#{AktuelleSchritteForm.myPlugin.cancel}" />
		</c:if>

        <intranda:breadcrumb label="#{myPageTitle}" noSeparator="#{true}" />
    </ui:define>

	<ui:define name="info">
	</ui:define>

	<ui:define name="content">

		<style>
			.big-image-caption {
				text-align: center;
			}

			.div-image img {
				float: right;
				border: solid 1px;
				border-color: lightgrey;
			}

			.img-active {
				background-color: #368ee0;
				color: white;
			}

			.image-navigation {
				margin-bottom: 5px;
			}

			#image-control-wrapper {
				margin-left: 6px;
			}

			#mainImage {
				width: 100%;
			}

			.pagenum {
				opacity: 0.2;
				background: #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
			}

			.title {
				opacity: 0.2;
				background-color: #{AktuelleSchritteForm.myPlugin.colors['title']};
			}

			.author {
				opacity: 0.2;
				background-color: #{AktuelleSchritteForm.myPlugin.colors['author']};
			}

			.institution {
				opacity: 0.2;
				background-color: #{AktuelleSchritteForm.myPlugin.colors['institution']};
			}

			.entry {
				opacity: 0.2;
				background-color: #{AktuelleSchritteForm.myPlugin.colors['entry']};
			}

			.pagenum-border {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
			}

			.title-border {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['title']};
			}

			.author-border {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['author']};
			}

			.institution-border {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['institution']};
			}

			.entry-border {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['entry']};
			}

			.active-entry .pagenum-border-focus {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['pagenum']};
			}

			.active-entry .title-border-focus {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['title']};
			}

			.active-entry .author-border-focus {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['author']};
			}

			.active-entry .institution-border-focus {
				border: 1px solid #{AktuelleSchritteForm.myPlugin.colors['institution']};
			}

			.active-entry .control-label label {
				font-weight: bold;
			}

			.toc-entry.active-entry .form-group .col-sm-9 {
				background-color: #f6f6f6;
			}

			.toc-entry.active-entry .form-group {
				background-color: #e6e6e6;
			}

			.toc-entry.moving .form-group {
				border-right: 3px solid black !important;
			}

			.toc-entry.moving .form-group:first-child {
				border-top: 3px solid black;
			}

			.toc-entry.moving .form-group:last-child {
				border-bottom: 3px solid black !important;
			}

			.entry-actions {
				background: white;
				display: flex;
				flex-direction: column;
				gap: calc(var(--flow-space, 1em) / 4);
				padding: calc(var(--flow-space, 1em) / 2);
			}

			.scroll-y {
				overflow-y: auto;
				overflow-x: hidden;
				direction: rtl;
				margin-bottom: var(--flow-space, 1em);
			}

			.scroll-y div {
				direction: ltr;
			}

			.max-height {
				--entry-list-height: calc(100vh - 300px);
				max-height: var(--entry-list-height);
				height: var(--entry-list-height);
			}
			.image-navigation {
				padding-bottom: 0;
				border: 0;
			}

			#bottomControls {
				padding-top: 0;
			}

			.dropArea {
				height: 50px;
				width: 100%;
				display: block;
				font-size: 32px;
				color: black !important;
				text-align: center;
			}

			.dropArea:hover {
				background-color: #ccc;
			}
		</style>


        <script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon-viewerinputhook.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/rx.lite.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/q.min.js"></script>
			<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/imageView.min.js"></script>
		<script type="text/javascript"
			src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/tocCorrection.js"></script>

		<section:section type="neutral">
			<section:header
				icon="puzzle-piece"
				title="#{msgs.plugin}: #{msgs[('plugin_').concat(AktuelleSchritteForm.myPlugin.title)]}">
				<section:header-actions>
					<h:commandLink
						id="id10"
						action="#{NavigationForm.Reload}"
						styleClass="btn d-flex align-items-center btn--title-action"
						title="#{msgs.reload}"
						pt:data-bs-trigger="tooltip">
						<span
							aria-hidden="true"
							class="fa fa-refresh" />
					</h:commandLink>
				</section:header-actions>
			</section:header>
			<section:body padding="true">
				<h:panelGroup
					layout="block"
					rendered="#{AktuelleSchritteForm.myPlugin.tih.sizeOfImageList == 0}"
					styleClass="alert alert-info">
					<h:outputText value="#{msgs.noImagesFound}" />
				</h:panelGroup>
				<h:form
					id="qaform"
					styleClass="row"
					rendered="#{AktuelleSchritteForm.myPlugin.tih.sizeOfImageList gt 0}">
					<div class="col-12 col-sm-7">
						<h:panelGroup
							id="entrylist"
							layout="block"
							class="max-height scroll-y">
							<h:panelGroup
								id="dropZero"
								layout="block"
								styleClass="row"
								rendered="#{AktuelleSchritteForm.myPlugin.inserting and AktuelleSchritteForm.myPlugin.movingEntryIdx != 0}">
								<div class="col-sm-11">
									<h:commandLink
										id="pasteButton"
										action="#{AktuelleSchritteForm.myPlugin.moveEntry(0)}"
										styleClass="dropArea">
										<f:ajax render=":qaform:entrylist" />
										<span
											aria-hidden="true"
											class="fa fa-paste" />
									</h:commandLink>
								</div>
							</h:panelGroup>
							<div class="d-flex flex-column gap-2 mx-2">
								<ui:repeat
									value="#{AktuelleSchritteForm.myPlugin.tih.image.entryList}"
									var="entry"
									varStatus="idx">
									<div class="field-set border">
										<div
											class="field-set-content toc-entry #{entry.moving ? 'moving' : ''}"
											id="tocEntry#{idx.index}">
											<intranda:formInputTextAjax
												label="#{msgs.plugin_intranda_step_olr_toc_title}"
												field="#{entry.title}" classLeft="form-label" classRight="form-input" rowClass="form-row"
												help="#{msgs.plugin_intranda_step_olr_toc_title}"
												name="title" fieldStyle="form-control title-border-focus"
												displayAsRequired="false" required="false" forceId="false"
												execute="@this"
												pt:data-plugin-drawRect="#{idx.index}"
												onfocus="highlightTocEntry(this);"
												/>
											<intranda:formInputTextAjax
												label="#{msgs.plugin_intranda_step_olr_toc_authors}"
												field="#{entry.authors}" classLeft="form-label" classRight="form-input" rowClass="form-row"
												help="#{msgs.plugin_intranda_step_olr_toc_authors}"
												name="authors" fieldStyle="form-control author-border-focus"
												displayAsRequired="false" required="false" forceId="false"
												execute="@this"
												pt:data-plugin-drawRect="#{idx.index}"
												onfocus="highlightTocEntry(this);"
												/>
											<intranda:formInputTextAjax
												label="#{msgs.plugin_intranda_step_olr_toc_page}"
												field="#{entry.pageLabel}" classLeft="form-label" classRight="form-input" rowClass="form-row"
												help="#{msgs.plugin_intranda_step_olr_toc_page}"
												name="pageLabel" fieldStyle="form-control pagenum-border-focus"
												displayAsRequired="false" required="false" forceId="false"
												execute="@this"
												pt:data-plugin-drawRect="#{idx.index}"
												onfocus="highlightTocEntry(this);"
												/>
											</div>
											<div class="entry-actions">
												<h:commandLink
													title="#{msgs.plugin_intranda_step_olr_toc_deleteEntry}"
													id="deleteButton"
													action="#{AktuelleSchritteForm.myPlugin.tih.image.removeEntry}"
													styleClass="btn">
													<span
														aria-hidden="true"
														class="fa fa-trash-o" />
													<f:passThroughAttribute
														name="data-bs-toggle"
														value="tooltip" />
													<f:passThroughAttribute
														name="data-entryid"
														value="#{idx.index}" />
													<f:setPropertyActionListener
														value="#{entry}"
														target="#{AktuelleSchritteForm.myPlugin.tih.image.currentEntry}"/>
													<f:ajax render=":qaform:entrylist :qaform:bigimage" />
												</h:commandLink>
												<br />
												<h:commandLink
													title="#{msgs.plugin_intranda_step_olr_toc_moveEntry}"
													id="moveButton"
													action="#{AktuelleSchritteForm.myPlugin.tih.image.removeEntry}"
													styleClass="btn"
													rendered="#{not AktuelleSchritteForm.myPlugin.inserting}">
													<span
														aria-hidden="true"
														class="fa fa-scissors" />
													<f:passThroughAttribute
														name="data-bs-toggle"
														value="tooltip" />
													<f:passThroughAttribute
														name="data-entryid"
														value="#{idx.index}" />
													<f:setPropertyActionListener
														value="true"
														target="#{AktuelleSchritteForm.myPlugin.inserting}"/>
													<f:setPropertyActionListener
														value="true"
														target="#{entry.moving}"/>
													<f:setPropertyActionListener
														value="#{idx.index}"
														target="#{AktuelleSchritteForm.myPlugin.movingEntryIdx}"/>
													<f:ajax render=":qaform:entrylist :qaform:bigimage" />
												</h:commandLink>
												<h:commandLink
													id="abortButton"
													title="#{msgs.plugin_intranda_step_olr_toc_abortMove}"
													rendered="#{AktuelleSchritteForm.myPlugin.inserting and AktuelleSchritteForm.myPlugin.movingEntryIdx == idx.index}"
													action="#{AktuelleSchritteForm.myPlugin.abortMove}"
													styleClass="btn">
													<f:passThroughAttribute
														name="data-entryid"
														value="#{idx.index}" />
													<span
														aria-hidden="true"
														class="fa fa-ban" />
													<f:ajax render=":qaform:entrylist :qaform:bigimage" />
												</h:commandLink>
											</div>
									</div>

									<h:panelGroup
										id="dropZero#{idx.index}"
										layout="block"
										styleClass="row"
										rendered="#{AktuelleSchritteForm.myPlugin.inserting and AktuelleSchritteForm.myPlugin.movingEntryIdx != idx.index and AktuelleSchritteForm.myPlugin.movingEntryIdx != idx.index+1}">
										<h:commandLink
											id="pasteButton"
											action="#{AktuelleSchritteForm.myPlugin.moveEntry(idx.index+1)}"
											styleClass="dropArea">
											<f:passThroughAttribute
												name="data-entryid"
												value="#{idx.index}" />
											<f:ajax render=":qaform:entrylist :qaform:bigimage" />
											<span
												aria-hidden="true"
												class="fa fa-paste" />
										</h:commandLink>
									</h:panelGroup>
								</ui:repeat>
							</div>

						</h:panelGroup>
						<button:row styleClass="justify-content-end">
							<!-- Remove all entries of this page -->
							<h:commandLink
								title="#{msgs.plugin_intranda_step_olr_toc_deleteAllEntriesOfThisPage}"
								action="#{AktuelleSchritteForm.myPlugin.tih.image.removeAllEntriesOfThisPage}"
								styleClass="btn btn-hot"
								onclick="if (!confirm('#{msgs.wirklichAusfuehren}')) return false" >
								<span
									aria-hidden="true"
									class="fa fa-trash-o" />
								<span>
									<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_deleteAllEntriesOfThisPage}"/>
								</span>
							</h:commandLink>
							<!-- Create new entry -->
							<h:commandLink
								title="#{msgs.plugin_intranda_step_olr_toc_createEntry}"
								styleClass="btn btn-primary-400"
								action="#{AktuelleSchritteForm.myPlugin.tih.image.createEntry}"
								id="addEntryButton">
								<span
									aria-hidden="true"
									class="fa fa-plus" />
								<span>
									<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_createEntry}"/>
								</span>
								<f:ajax render=":qaform:entrylist"/>
							</h:commandLink>
							<!-- Create page numbers -->
							<h:commandLink
								title="#{msgs.plugin_intranda_step_olr_toc_createPagenumbers}"
								styleClass="btn btn-blank"
								action="#{AktuelleSchritteForm.myPlugin.generateEndNumbers}">
								<span
									aria-hidden="true"
									class="fa fa-sort-numeric-asc" />
								<span>
									<h:outputText value="#{msgs.plugin_intranda_step_olr_toc_createPagenumbers}"/>
								</span>
								<f:ajax render=":qaform:entrylist"/>
							</h:commandLink>
						</button:row>
					</div>
					<div class="col-12 col-sm-5 d-flex flex-column">
						<h:panelGroup id="bigimage" layout="block" styleClass="d-flex flex-column flex-grow-1">
							<div class="row" id="topImageNav">
								<f:subview id="first_image">
									<ui:include
										src="OlrTocCorrectionPlugin_include_imagenavigation.xhtml" />
								</f:subview>
							</div>
							<!-- big image -->
							<h:panelGroup layout="block" class="d-flex flex-column flex-grow-1" id="imageOrOcr">
								<h:panelGroup styleClass="div-image flex-grow-1 d-flex flex-column m-3 border" layout="block" rendered="#{not AktuelleSchritteForm.myPlugin.showOCR}">
									<!--                                     <h:graphicImage class="margin-bottom-regular" value="#{AktuelleSchritteForm.myPlugin.bild}" rendered="#{AktuelleSchritteForm.myPlugin.image != null}" width="100%" /> -->
									<div id="mainImage" class="flex-grow-1"
										rendered="#{AktuelleSchritteForm.myPlugin.tih.image != null}" />
								</h:panelGroup>
								<h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.showOCR}">
									<h:outputText value="#{AktuelleSchritteForm.myPlugin.tih.image.ocrText}" escape="false"/>
								</h:panelGroup>
							</h:panelGroup>
							<!-- // big image -->

						</h:panelGroup>
					</div>
					<h:inputHidden
						id="entriesJson"
						value="#{AktuelleSchritteForm.myPlugin.tih.image.entriesAsJSON}" />
					<h:inputHidden
						id="tileSource"
						value="#{AktuelleSchritteForm.myPlugin.tih.image.imageUrl}" />
					<h:inputHidden
						id="processId"
						value="#{AktuelleSchritteForm.myPlugin.step.processId}" />
					<h:inputHidden
						id="scaleFactor"
						value="#{AktuelleSchritteForm.myPlugin.tih.image.scale}" />
					<h:inputHidden
						id="showAllEntries"
						value="#{NavigationForm.uiStatus.olr_showAllEntries}" />
				</h:form>
			</section:body>
			<h:form>
				<section:footer>
					<!-- Cancel -->
					<h:commandLink
						styleClass="btn btn-blank"
						id="cancel"
						action="#{AktuelleSchritteForm.myPlugin.cancel}">
						<h:outputText
							value="#{msgs.plugin_intranda_step_olr_toc_pluginLeave}" />
					</h:commandLink>
					<!-- Pica preview -->
					<h:commandLink
						styleClass="btn btn-blank"
						id="showPicaPreview"
						action="#{AktuelleSchritteForm.myPlugin.showPicaPreview}"
						onclick="console.log('PICA Preview button clicked');">
						<h:outputText
							value="#{msgs.plugin_intranda_step_olr_toc_showPicaPreview}" />
						<f:ajax render="picaModalForm:picaModalContent" onevent="(event) => {
							if (event.status === 'success') {showPicaModal();}
						}" />
					</h:commandLink>
					<!-- Save -->
					<h:commandLink
						styleClass="btn btn-success"
						id="save"
						action="#{AktuelleSchritteForm.myPlugin.finish}">
						<span
							aria-hidden="true"
							class="fa fa-save" />
						<span>
							<h:outputText
								value="#{msgs.plugin_intranda_step_olr_toc_saveAndLeave}" />
						</span>
					</h:commandLink>
				</section:footer>
			</h:form>
		</section:section>

		<!-- PICA Preview Modal -->
		<div class="modal fade" id="picaPreviewModal" tabindex="-1" role="dialog" aria-labelledby="picaPreviewModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="picaPreviewModalLabel">PICA</h5>
						<button type="button" class="btn text-white" data-bs-dismiss="modal" aria-label="Close">
							<span aria-hidden="true" class="fa fa-times"></span>
						</button>
					</div>
					<div class="modal-body">
						<h:form id="picaModalForm">
							<h:panelGroup id="picaModalContent" layout="block">
								<h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.picaPreview != null}" layout="block"
									style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; background-color: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 0.25rem;">
									<h:outputText value="#{AktuelleSchritteForm.myPlugin.picaPreview}" escape="false"/>
								</h:panelGroup>
								<h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.picaPreview == null}" layout="block"
									styleClass="alert alert-warning">
									<h:outputText value="No PICA preview available." />
								</h:panelGroup>
							</h:panelGroup>
						</h:form>
					</div>
					<div class="modal-footer">
						<h:form>
							<h:commandLink
								styleClass="btn btn-secondary"
								action="#{AktuelleSchritteForm.myPlugin.closePicaPreview}">
								#{msgs.close}
								<f:ajax render="picaModalForm:picaModalContent" onevent="(event) => {if (event.status === 'success') {hidePicaModal();}}" />
							</h:commandLink>
						</h:form>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			function showPicaModal() {
				let modal = new bootstrap.Modal(document.getElementById('picaPreviewModal'));
				modal.show();
			}

			function hidePicaModal() {
				let modal = bootstrap.Modal.getInstance(document.getElementById('picaPreviewModal'));
				if (modal) {
					modal.hide();
				}
			}
		</script>
	</ui:define>

</ui:composition>